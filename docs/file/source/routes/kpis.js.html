<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">source/routes/kpis.js | expressapp</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-src-components">client/src/components</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/source/client/src/components/App.js~App.html">App</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/source/client/src/components/HomePage.js~HomePage.html">HomePage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-SignIn">SignIn</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-SignUp">SignUp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-StepSelectionPage">StepSelectionPage</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-src-components-definitionstep">client/src/components/DefinitionStep</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/source/client/src/components/DefinitionStep/DefinitionBoard.js~DefinitionBoard.html">DefinitionBoard</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/source/client/src/components/DefinitionStep/DefinitionCards.js~DefinitionCards.html">DefinitionCards</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/source/client/src/components/DefinitionStep/DefinitionList.js~DefinitionList.html">DefinitionList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Definition">Definition</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-src-components-longliststep">client/src/components/LonglistStep</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/source/client/src/components/LonglistStep/LonglistBoard.js~LonglistBoard.html">LonglistBoard</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/source/client/src/components/LonglistStep/LonglistManualImport.js~LonglistManualImport.html">LonglistManualImport</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/source/client/src/components/LonglistStep/LonglistXMLImport.js~LonglistXMLImport.html">LonglistXMLImport</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Longlist">Longlist</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-src-components-shortliststep">client/src/components/ShortlistStep</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/source/client/src/components/ShortlistStep/ShortListBoard.js~ShortListBoard.html">ShortListBoard</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ShortList">ShortList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ShortListBoardList">ShortListBoardList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateListItems">generateListItems</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ShortListBoardTarget">ShortListBoardTarget</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateTargetTokens">generateTargetTokens</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-src-components-visualizationstep">client/src/components/VisualizationStep</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/source/client/src/components/VisualizationStep/DefinedKPIChart.js~DefinedKPIChart.html">DefinedKPIChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/source/client/src/components/VisualizationStep/TotalScoreKPIChart.js~TotalScoreKPIChart.html">TotalScoreKPIChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/source/client/src/components/VisualizationStep/VisualizationPanel.js~VisualizationPanel.html">VisualizationPanel</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-src-components-utils">client/src/components/utils</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/source/client/src/components/utils/NoMatch.js~NoMatch.html">NoMatch</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Header">Header</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-SimpleSnackbar">SimpleSnackbar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-src-utils">client/src/utils</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/source/client/src/utils/Api.js~Api.html">Api</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-trimStringToFit">trimStringToFit</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models">models</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Company">Company</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Kpi">Kpi</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Role">Role</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-User">User</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#routes">routes</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-completionState">completionState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-checkForInDatabaseNameDuplicates">checkForInDatabaseNameDuplicates</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-checkForInListNameDuplicates">checkForInListNameDuplicates</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-KpiDefinitionState">KpiDefinitionState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-companyRouter">companyRouter</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#routes-utils">routes/utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-checkCompany">checkCompany</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-checkUser">checkUser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-exports">exports</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">source/routes/kpis.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * @ignore
 */
var express = require(&apos;express&apos;);
/**
 * @ignore
 */
var router = express.Router();
/**
 * @ignore
 */
const Kpi = require(&apos;../models&apos;).kpi;
/**
 * @ignore
 */
const check = require(&apos;./utils/check&apos;);

check(router)

//
// Longlist, shortlist, definition step routes
//

/**
 * TODO
 */
function checkForInListNameDuplicates(list){
  for(let [i,x] of list.entries())
    for(let [j,y] of list.entries()){
      if(i !== j &amp;&amp; x.name===y.name){
        return true
      }
    }
  return false
}

/**
 * TODO
 */
function checkForInDatabaseNameDuplicates(list){
  let promises = []
  for(let k of list){
    promises.push(
      Kpi.findOne({ where: { name: k.name }} )
    )
  }
  return Promise.all(promises)
  .then( res =&gt; {
    console.log(res)
    if(res.every(e =&gt; e===null)) return false
    else return true
  })
  .catch( err =&gt; {
    console.error(err)
    return true
  })
}

router.post(&apos;/&apos;, function(req, res, next) {
  let promises = [];
  checkForInDatabaseNameDuplicates(req.body.kpis).then(
    dbCheck =&gt; {
      let listCheck = checkForInListNameDuplicates(req.body.kpis)
      
      let bothChecks = listCheck || dbCheck

      if(bothChecks){
        res.status(400);
        res.send({ error: &apos;List contains duplicated kpis&apos; });
      }
      else{
        for (let k of req.body.kpis) {
          promises.push(
            Kpi.create({
              name: k.name,
              description: null,
              status: 0,
              easeOfMeasure: null,
              importance: null,
              companyId: req.body.companyId,
              createdByUserId: req.body.userId
            })
          );
        }
      
        Promise.all(promises)
          .then(function(e) {
            res.send({ success: e });
          })
          .catch(function(err) {
            next(err);
          });   
      }
    }
  )
});

router.get(&apos;/:companyId/:userId&apos;, function(req, res) {
  Kpi.findAll().then(function(k) {
    res.send({success:k});
  });
});

router.get(&apos;/:companyId/:userId/names&apos;, function(req, res) {
  Kpi.findAll().then(function(k) {
    res.send({success:k.map((k)=&gt;({id:k.id,name:k.name}))});
  });
});

router.get(&apos;/:companyId/:userId/:kpiId&apos;, function(req, res, next) {
  Kpi.findOne({ where: { id: req.params.kpiId }} ).then(function(k) {
    res.send({success:k});
  })
  .catch(function(err) {
    next(err);
  });
});

router.post(&apos;/definition&apos;, function(req, res, next) {
  if(req.body.definition){
    if (req.body.kpiId) {
      Kpi.findOne({ where: { id: req.body.kpiId } })
      .then(function(k) {
        if (k) {
          k.update({
            purpose: req.body.definition.purpose,
            customers: req.body.definition.customers,
            datasources:  req.body.definition.datasources,
            formula: req.body.definition.formula,
            resources:  req.body.definition.resources,
            problems: req.body.definition.problems,
            targets: req.body.definition.targets,
            outcomes: req.body.definition.outcomes,
            cost: req.body.definition.cost,
            definedByUserId : req.body.userId,
            status: 3,
          })
          .then(function(k) {
            res.send({ success: k });
          })
          .catch(function(err){
            next(err)
          })
        } else {
          res.status(404);
          res.send({ error: &apos;kpiId unknown&apos; });
        }
      })
      .catch(function(err) {
        next(err);
      });
    } else {
      res.status(400);
      res.send({ error: &apos;No kpiId provided&apos; });
    }
  }
  else {
    res.status(400);
    res.send({ error: &apos;No kpi definition provided&apos; });
  }
});

router.post(&apos;/shortlist&apos;, function(req, res, next) {
  let findPromises = []
  let updatePromises = []
  for(let o of req.body.kpisToSave){
    if (o.kpiId) {
      findPromises.push(
        Kpi.findOne({ where: { id: o.kpiId } })
        .then(function(k) {
          updatePromises.push(
            k.update({
              easeOfMeasure: o.score.easeOfMeasure,
              importance: o.score.importance,
              status: o.shortlisted?2:1,
              comment: o.comment,
            })
          );
        })
      )
    }
  }
  Promise.all(findPromises)
    .then(function(found) {
      Promise.all(updatePromises)
      .then(function(updated) {
        res.send({ success: updated });
      })
      .catch(function(err) {
        next(err);
      });
    })
    .catch(function(err) {
      next(err);
    });
});

module.exports = router;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
